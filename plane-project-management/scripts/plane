#!/bin/bash
# Plane CLI - Single command interface for all Plane operations
# Optimized for minimal API calls using caching
#
# Usage:
#   plane [-w WORKSPACE] <command> [args]
#
# Options:
#   -w WORKSPACE    Specify workspace slug (or set PLANE_WORKSPACE env var)
#
# Commands:
#   workspaces                - List available workspaces
#   status [PROJECT]          - Show project status summary
#   todo [PROJECT]            - List todo items
#   doing [PROJECT]           - List in-progress items
#   done [PROJECT]            - List completed items
#   start PROJECT SEQ         - Move to In Progress
#   finish PROJECT SEQ        - Move to Done
#   stop PROJECT SEQ          - Move back to Todo
#   new PROJECT "NAME"        - Create issue
#   project-new "NAME" "ID" ["DESC"] - Create new project
#   comment PROJECT SEQ "MSG" - Add comment to issue
#   show PROJECT SEQ          - Show issue details with comments
#   cycles PROJECT            - List cycles
#   pages PROJECT             - List pages
#   page-new PROJECT "NAME" ["HTML"] - Create new page
#   refresh                   - Clear cache

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CACHE_DIR="/tmp/plane_cache"
COOKIE_FILE="/tmp/plane_cookies.txt"

# Load environment from ~/.claude/.env (non-secret values)
if [ -f ~/.claude/.env ]; then
    while IFS='=' read -r key value; do
        [[ "$key" =~ ^#.*$ ]] && continue
        [[ -z "$key" ]] && continue
        value="${value%\'}"
        value="${value#\'}"
        export "$key=$value"
    done < ~/.claude/.env
fi

# Load secrets from Phase (if available)
phase_get() {
    phase secrets get "$1" --app claude-code 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin).get('value',''))" 2>/dev/null
}

if command -v phase &> /dev/null; then
    export PLANE_API_KEY=$(phase_get PLANE_API_KEY)
    export PLANE_USERNAME=$(phase_get PLANE_USERNAME)
    export PLANE_PASSWORD=$(phase_get PLANE_PASSWORD)
fi

# Parse options
while getopts "w:" opt; do
    case $opt in
        w) PLANE_WORKSPACE="$OPTARG" ;;
        *) ;;
    esac
done
shift $((OPTIND-1))

# Check if workspace is required (not needed for 'workspaces' or 'help' commands)
cmd_check="$1"
if [ -z "$PLANE_WORKSPACE" ] && [ "$cmd_check" != "workspaces" ] && [ "$cmd_check" != "help" ] && [ "$cmd_check" != "h" ] && [ -n "$cmd_check" ]; then
    echo "Error: No workspace specified."
    echo "Use: plane -w WORKSPACE <command>"
    echo "  or: export PLANE_WORKSPACE=your-workspace"
    echo ""
    echo "To list available workspaces: plane workspaces"
    exit 1
fi

# Ensure cache dir
mkdir -p "$CACHE_DIR"

# =============================================================================
# CACHING FUNCTIONS
# =============================================================================

cache_valid() {
    local file="$1"
    local ttl="${2:-3600}"
    [ -f "$file" ] && [ $(($(date +%s) - $(stat -f %m "$file" 2>/dev/null || stat -c %Y "$file" 2>/dev/null))) -lt "$ttl" ]
}

get_projects() {
    local cache="$CACHE_DIR/projects.json"
    if ! cache_valid "$cache"; then
        curl -s -H "X-API-Key: $PLANE_API_KEY" \
            "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/" > "$cache"
    fi
    cat "$cache"
}

get_project_id() {
    local identifier="$1"
    get_projects | python3 -c "
import sys, json
data = json.load(sys.stdin)
for p in data.get('results', []):
    if p['identifier'] == '$identifier':
        print(p['id'])
        break"
}

get_states() {
    local project_id="$1"
    local cache="$CACHE_DIR/states_${project_id}.json"
    if ! cache_valid "$cache"; then
        curl -s -H "X-API-Key: $PLANE_API_KEY" \
            "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/$project_id/states/" > "$cache"
    fi
    cat "$cache"
}

get_state_id() {
    local project_id="$1"
    local state_name="$2"
    get_states "$project_id" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for s in data.get('results', []):
    if s['name'].lower() == '$state_name'.lower():
        print(s['id'])
        break"
}

ensure_session() {
    if cache_valid "$COOKIE_FILE" 1800; then
        return 0
    fi

    local csrf_response=$(curl -s -c "$COOKIE_FILE" "$PLANE_API_URL/auth/get-csrf-token/")
    local csrf_token=$(echo "$csrf_response" | python3 -c "import sys, json; print(json.load(sys.stdin).get('csrf_token',''))" 2>/dev/null)

    curl -s -c "$COOKIE_FILE" -b "$COOKIE_FILE" -X POST "$PLANE_API_URL/auth/sign-in/" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -H "Origin: $PLANE_API_URL" \
        --data-urlencode "csrfmiddlewaretoken=$csrf_token" \
        --data-urlencode "email=$PLANE_USERNAME" \
        --data-urlencode "password=$PLANE_PASSWORD" >/dev/null 2>&1
}

get_issues() {
    local project_id="$1"
    ensure_session
    curl -s -b "$COOKIE_FILE" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/"
}

# =============================================================================
# DISPLAY FUNCTIONS
# =============================================================================

list_issues_by_state() {
    local project="$1"
    local state_group="$2"
    local project_id=$(get_project_id "$project")

    if [ -z "$project_id" ]; then
        echo "Project '$project' not found"
        return 1
    fi

    get_issues "$project_id" | python3 -c "
import sys, json
data = json.load(sys.stdin)
results = data.get('results', []) if isinstance(data, dict) else data
state_group = '$state_group'
for issue in results:
    if state_group and issue.get('state__group') != state_group:
        continue
    seq = issue['sequence_id']
    pri = issue.get('priority', 'none')[:1].upper()
    name = issue['name'][:60]
    print(f'{seq:3} [{pri}] {name}')"
}

show_status() {
    local project="$1"

    if [ -z "$project" ]; then
        # Show all projects summary
        echo "Projects:"
        get_projects | python3 -c "
import sys, json
data = json.load(sys.stdin)
for p in data.get('results', []):
    print(f\"  {p['identifier']:6} {p['name']}\")"
        return
    fi

    local project_id=$(get_project_id "$project")
    if [ -z "$project_id" ]; then
        echo "Project '$project' not found"
        return 1
    fi

    echo "$project Status:"
    get_issues "$project_id" | python3 -c "
import sys, json
data = json.load(sys.stdin)
results = data.get('results', []) if isinstance(data, dict) else data
counts = {'backlog': 0, 'unstarted': 0, 'started': 0, 'completed': 0}
for issue in results:
    group = issue.get('state__group', 'backlog')
    if group in counts:
        counts[group] += 1
print(f\"  Backlog:     {counts['backlog']}\")
print(f\"  Todo:        {counts['unstarted']}\")
print(f\"  In Progress: {counts['started']}\")
print(f\"  Done:        {counts['completed']}\")"
}

# =============================================================================
# ACTION FUNCTIONS
# =============================================================================

move_issue() {
    local project="$1"
    local seq_id="$2"
    local target_state="$3"

    local project_id=$(get_project_id "$project")
    local state_id=$(get_state_id "$project_id" "$target_state")

    # Get issue ID by sequence
    local issue_id=$(curl -s -H "X-API-Key: $PLANE_API_KEY" \
        "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
for issue in data.get('results', []):
    if issue['sequence_id'] == $seq_id:
        print(issue['id'])
        break")

    if [ -z "$issue_id" ]; then
        echo "Issue $project-$seq_id not found"
        return 1
    fi

    curl -s -X PATCH -H "X-API-Key: $PLANE_API_KEY" -H "Content-Type: application/json" \
        "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/$issue_id/" \
        -d "{\"state\": \"$state_id\"}" >/dev/null

    echo "$project-$seq_id -> $target_state"
}

create_issue() {
    local project="$1"
    local name="$2"
    local priority="${3:-none}"

    local project_id=$(get_project_id "$project")

    local result=$(curl -s -X POST -H "X-API-Key: $PLANE_API_KEY" -H "Content-Type: application/json" \
        "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/" \
        -d "{\"name\": \"$name\", \"priority\": \"$priority\"}")

    local seq_id=$(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin).get('sequence_id','?'))" 2>/dev/null)
    echo "Created: $project-$seq_id"
}

list_cycles() {
    local project="$1"
    local project_id=$(get_project_id "$project")
    ensure_session

    curl -s -b "$COOKIE_FILE" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/cycles/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
cycles = data if isinstance(data, list) else data.get('results', [])
for c in cycles:
    status = c.get('status', '?')
    start = c.get('start_date', '')[:10]
    end = c.get('end_date', '')[:10]
    print(f\"{c['name']}: {status} ({start} - {end})\")"
}

list_pages() {
    local project="$1"
    local project_id=$(get_project_id "$project")
    ensure_session

    curl -s -b "$COOKIE_FILE" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/pages/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
pages = data if isinstance(data, list) else data.get('results', [])
for p in pages:
    print(f\"{p['name']}\")"
}

create_page() {
    local project="$1"
    local name="$2"
    local content="${3:-<p>New page</p>}"

    local project_id=$(get_project_id "$project")
    ensure_session

    # Escape content for JSON
    local escaped_content=$(echo "$content" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read().strip()))")

    local result=$(curl -s -X POST -b "$COOKIE_FILE" -H "Content-Type: application/json" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/pages/" \
        -d "{\"name\": \"$name\", \"description_html\": $escaped_content, \"access\": 0}")

    local page_name=$(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin).get('name','?'))" 2>/dev/null)
    echo "Created page: $page_name"
}

list_workspaces() {
    ensure_session
    curl -s -b "$COOKIE_FILE" \
        "$PLANE_API_URL/api/users/me/workspaces/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
workspaces = data if isinstance(data, list) else data.get('results', [])
print('Available workspaces:')
for w in workspaces:
    slug = w.get('slug', '?')
    name = w.get('name', '?')
    print(f'  {slug:20} {name}')"
}

create_project() {
    local name="$1"
    local identifier="$2"
    local description="${3:-}"

    local result=$(curl -s -X POST -H "X-API-Key: $PLANE_API_KEY" -H "Content-Type: application/json" \
        "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/" \
        -d "{\"name\": \"$name\", \"identifier\": \"$identifier\", \"description\": \"$description\"}")

    local proj_id=$(echo "$result" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('identifier', d.get('error', '?')))" 2>/dev/null)

    if echo "$result" | grep -q "error"; then
        echo "Error: $(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error', 'Unknown error'))" 2>/dev/null)"
    else
        echo "Created project: $proj_id"
        # Clear project cache
        rm -f "$CACHE_DIR/projects.json"
    fi
}

show_issue() {
    local project="$1"
    local seq_id="$2"

    local project_id=$(get_project_id "$project")
    ensure_session

    # Get issue details (use session API for state__group)
    local issue_data=$(curl -s -b "$COOKIE_FILE" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
results = data.get('results', []) if isinstance(data, dict) else data
for issue in results:
    if issue['sequence_id'] == $seq_id:
        print(json.dumps(issue))
        break")

    if [ -z "$issue_data" ]; then
        echo "Issue $project-$seq_id not found"
        return 1
    fi

    local issue_id=$(echo "$issue_data" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")

    # Display issue details
    echo "$issue_data" | python3 -c "
import sys, json
issue = json.load(sys.stdin)
print(f\"$project-{issue['sequence_id']}: {issue['name']}\")
print(f\"Priority: {issue.get('priority', 'none')}\")
print(f\"State: {issue.get('state__group', 'unknown')}\")
desc = issue.get('description_stripped', '')
if desc:
    print(f\"\\nDescription:\\n{desc[:500]}\")"

    # Get comments
    echo ""
    echo "Comments:"
    ensure_session
    curl -s -b "$COOKIE_FILE" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/$issue_id/comments/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
comments = data if isinstance(data, list) else data.get('results', [])
if not comments:
    print('  (no comments)')
else:
    for c in comments:
        actor = c.get('actor_detail', {}).get('display_name', 'Unknown')
        text = c.get('comment_stripped', c.get('comment_html', ''))[:200]
        created = c.get('created_at', '')[:10]
        print(f\"  [{created}] {actor}: {text}\")"
}

add_comment() {
    local project="$1"
    local seq_id="$2"
    local comment="$3"

    local project_id=$(get_project_id "$project")

    # Get issue ID by sequence
    local issue_id=$(curl -s -H "X-API-Key: $PLANE_API_KEY" \
        "$PLANE_API_URL/api/v1/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/" | \
        python3 -c "
import sys, json
data = json.load(sys.stdin)
for issue in data.get('results', []):
    if issue['sequence_id'] == $seq_id:
        print(issue['id'])
        break")

    if [ -z "$issue_id" ]; then
        echo "Issue $project-$seq_id not found"
        return 1
    fi

    ensure_session

    # Escape comment for JSON
    local escaped_comment=$(echo "$comment" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read().strip()))")

    curl -s -X POST -b "$COOKIE_FILE" -H "Content-Type: application/json" \
        "$PLANE_API_URL/api/workspaces/$PLANE_WORKSPACE/projects/$project_id/issues/$issue_id/comments/" \
        -d "{\"comment_html\": \"<p>$comment</p>\"}" >/dev/null

    echo "Comment added to $project-$seq_id"
}

# =============================================================================
# MAIN
# =============================================================================

cmd="$1"
shift

case "$cmd" in
    workspaces) list_workspaces ;;
    status|s)   show_status "$1" ;;
    todo|t)     list_issues_by_state "$1" "unstarted" ;;
    doing|d)    list_issues_by_state "$1" "started" ;;
    done)       list_issues_by_state "$1" "completed" ;;
    backlog|b)  list_issues_by_state "$1" "backlog" ;;
    start)      move_issue "$1" "$2" "In Progress" ;;
    finish|f)   move_issue "$1" "$2" "Done" ;;
    stop)       move_issue "$1" "$2" "Todo" ;;
    new|n)      create_issue "$1" "$2" "${3:-none}" ;;
    project-new) create_project "$1" "$2" "$3" ;;
    show)       show_issue "$1" "$2" ;;
    comment)    add_comment "$1" "$2" "$3" ;;
    cycles|c)   list_cycles "$1" ;;
    pages|p)    list_pages "$1" ;;
    page-new)   create_page "$1" "$2" "$3" ;;
    refresh|r)  rm -rf "$CACHE_DIR"/* "$COOKIE_FILE"; echo "Cache cleared" ;;
    help|h|"")
        echo "plane [-w WORKSPACE] <cmd> [args]"
        echo ""
        echo "  workspaces           List available workspaces"
        echo "  status [PROJECT]     Project summary (lists projects if no arg)"
        echo ""
        echo "  todo PROJECT         Todo items"
        echo "  doing PROJECT        In-progress items"
        echo "  done PROJECT         Completed items"
        echo "  backlog PROJECT      Backlog items"
        echo ""
        echo "  start PROJECT SEQ    Move to In Progress"
        echo "  finish PROJECT SEQ   Move to Done"
        echo "  stop PROJECT SEQ     Move back to Todo"
        echo ""
        echo "  new PROJECT NAME     Create issue"
        echo "  project-new NAME ID [DESC]  Create new project"
        echo "  show PROJECT SEQ     Show issue details + comments"
        echo "  comment PROJECT SEQ MSG  Add comment to issue"
        echo ""
        echo "  cycles PROJECT       List cycles"
        echo "  pages PROJECT        List pages"
        echo "  page-new PROJECT NAME [HTML]  Create page"
        echo ""
        echo "  refresh              Clear cache"
        echo ""
        echo "Set workspace: -w WORKSPACE or export PLANE_WORKSPACE=..."
        ;;
    *)
        echo "Unknown: $cmd (try 'plane help')"
        exit 1
        ;;
esac
